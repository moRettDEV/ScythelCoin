<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добавить новую трату</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1>Добавить новую трату</h1>

    <form id="expense-form">
        <div class="mb-3">
            <label for="name" class="form-label">Название траты:</label>
            <input type="text" id="name" name="name" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="amount" class="form-label">Сумма:</label>
            <input type="text" id="amount" name="amount" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Описание:</label>
            <input type="text" id="description" name="description" class="form-control">
        </div>

        <div class="mb-3">
            <label for="categories" class="form-label">Категории:</label>
            <select id="categories" name="categories[]" class="form-select" multiple required>
                <!-- Категории будут загружены через JS -->
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Добавить</button>
    </form>

    <hr>

    <h2>Список категорий</h2>
    <ul id="category-list">
        <!-- Список категорий будет загружен сюда -->
    </ul>

    <!-- Форма добавления новой категории -->
    <h3>Добавить новую категорию</h3>
    <form id="category-form">
        <div class="mb-3">
            <label for="category-name" class="form-label">Название категории:</label>
            <input type="text" id="category-name" name="name" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-success">Добавить категорию</button>
    </form>
</div>

<script>
    // Получаем категории с бэка
    fetch('/api/expenses/categories')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('categories');
            const categoryList = document.getElementById('category-list');

            // Очистить список перед добавлением
            categoryList.innerHTML = '';
            select.innerHTML = ''; // Очистить селект перед добавлением новых элементов

            data.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);

                // Также добавляем категорию в список на странице
                const listItem = document.createElement('li');
                listItem.textContent = category.name;
                categoryList.appendChild(listItem);
            });
        })
        .catch(error => console.error('Ошибка загрузки категорий:', error));

    // Обработчик формы для добавления траты
    const expenseForm = document.getElementById('expense-form');
    expenseForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const name = document.getElementById('name').value;
        const amount = document.getElementById('amount').value;
        const description = document.getElementById('description').value;
        const categories = Array.from(document.getElementById('categories').selectedOptions).map(option => option.value);

        const expenseData = { name, amount, description, categories };

        fetch('/api/expenses/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(expenseData)
        })
            .then(response => response.json())
            .then(data => {
                console.log('Трата добавлена', data);
            })
            .catch(error => {
                console.error('Ошибка при добавлении траты:', error);
            });
    });

    // Форма для добавления категории
    const categoryForm = document.getElementById('category-form');
    categoryForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const categoryName = document.getElementById('category-name').value;

        if (!categoryName) {
            alert('Пожалуйста, введите название категории');
            return;
        }

        // Отправляем данные для добавления новой категории
        fetch('/api/expenses/category/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: categoryName }),
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                // Обновляем список категорий после добавления
                fetch('/api/expenses/categories')
                    .then(response => response.json())
                    .then(data => {
                        const select = document.getElementById('categories');
                        const categoryList = document.getElementById('category-list');

                        // Очистить список перед добавлением
                        categoryList.innerHTML = '';
                        select.innerHTML = '';  // Очищаем селект
                        data.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            select.appendChild(option);

                            // Также добавляем категорию в список на странице
                            const listItem = document.createElement('li');
                            listItem.textContent = category.name;
                            categoryList.appendChild(listItem);
                        });
                    })
                    .catch(error => console.error('Ошибка загрузки категорий:', error));
            })
            .catch(error => {
                console.error('Ошибка добавления категории:', error);
            });
    });
</script>
</body>
</html>
